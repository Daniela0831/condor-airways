{% extends "base.html" %}
{% load static %}
{% block title %}Editar Vuelo{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/admin_custom.css' %}">

<div class="container my-5">
  <div class="card card-form shadow-lg mx-auto p-4" style="max-width: 650px;">
    <h3 class="text-center mb-4 fw-bold text-primary">
      锔 Editar informaci贸n del vuelo {{ vuelo.codigo }}
    </h3>

    <form method="POST" enctype="multipart/form-data" id="form-editar-vuelo">
      {% csrf_token %}

      <!-- C贸digo (solo lectura) -->
      <div class="mb-3">
        <label class="form-label fw-bold">C贸digo del vuelo</label>
        <input type="text" name="codigo" class="form-control" value="{{ vuelo.codigo }}" readonly>
      </div>

      <!-- Tipo -->
      <div class="mb-3">
        <label class="form-label fw-bold">Tipo de vuelo</label>
        <select name="tipo" id="id_tipo" class="form-select" required>
          <option value="NACIONAL" {% if vuelo.tipo == "NACIONAL" %}selected{% endif %}>Nacional</option>
          <option value="INTERNACIONAL" {% if vuelo.tipo == "INTERNACIONAL" %}selected{% endif %}>Internacional</option>
        </select>
      </div>

      <!-- Origen -->
      <div class="mb-3">
        <label class="form-label fw-bold">Origen</label>
        <select name="origen" id="id_origen" class="form-select" required></select>
      </div>

      <!-- Destino -->
      <div class="mb-3">
        <label class="form-label fw-bold">Destino</label>
        <select name="destino" id="id_destino" class="form-select" required></select>
      </div>

      <!-- Fechas y horas -->
      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label fw-bold">Fecha salida</label>
          <input type="date" name="fecha_salida" class="form-control" value="{{ vuelo.fecha_salida|date:'Y-m-d' }}" required>
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label fw-bold">Hora salida</label>
          <input type="time" name="hora_salida" class="form-control" value="{{ vuelo.hora_salida|time:'H:i' }}" required>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label fw-bold">Fecha llegada</label>
          <input type="date" name="fecha_llegada" class="form-control" value="{{ vuelo.fecha_llegada|date:'Y-m-d' }}">
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label fw-bold">Hora llegada</label>
          <input type="time" name="hora_llegada" class="form-control" value="{{ vuelo.hora_llegada|time:'H:i' }}">
        </div>
      </div>
      <div class="col-md-6">
        <label for="capacidad" class="form-label">Capacidad</label>
        <input type="number" id="capacidad" name="capacidad" value="{{ vuelo.capacidad }}" class="form-control" readonly>
      </div>
      <!-- Precio -->
      <div class="mb-3">
        <label class="form-label fw-bold">Precio (COP)</label>
        <input type="number" step="0.01" name="precio" class="form-control" value="{{ vuelo.precio }}" required>
      </div>

      <!-- Imagen -->
      <div class="mb-3">
        <label class="form-label fw-bold">Imagen</label>
        {% if vuelo.imagen %}
          <div class="mb-2">
            <img src="{{ vuelo.imagen.url }}" class="img-thumbnail" style="width: 150px; height: 100px; object-fit: cover;">
          </div>
        {% endif %}
        <input type="file" name="imagen" class="form-control">
      </div>

      <div class="form-check mb-3">
        {{ form.promocion_activa }}
        <label class="form-check-label" for="{{ form.promocion_activa.id_for_label }}">
            Activar promoci贸n
        </label>
      </div>

      <div class="mb-3">
          {{ form.descuento_porcentaje.label_tag }}
          {{ form.descuento_porcentaje }}
      </div>

      <div class="text-center mt-4">
        <button type="submit" class="btn btn-gradient px-5">
           Guardar cambios
        </button>
        <a href="{% url 'admin_dashboard' %}" class="btn btn-secondary ms-2 px-4">
          猬锔 Volver
        </a>
      </div>
    </form>
  </div>
</div>

<!-- Script para cargar opciones de origen/destino -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const tipoSelect = document.getElementById("id_tipo");
  const origenSelect = document.getElementById("id_origen");
  const destinoSelect = document.getElementById("id_destino");

  const nacionales = [
    "ARAUCA", "ARMENIA", "BARRANQUILLA", "BOGOTA", "BUCARAMANGA",
    "CALI", "CARTAGENA", "CUCUTA", "FLORENCIA", "IBAGUE",
    "INIRIDA", "LETICIA", "MANIZALES", "MEDELLIN", "MITU", "MOCOA",
    "MONTERIA", "NEIVA", "PASTO", "PEREIRA", "POPAYAN", "PUERTO_CARREO",
    "QUIBDO", "RIOHACHA", "SAN_ANDRES", "SAN_JOSE_DEL_GUAVIARE",
    "SANTA_MARTA", "SINCELEJO", "TUNJA", "VALLEDUPAR", "VILLAVICENCIO", "YOPAL"
  ];

  const origenInternacional = ["PEREIRA", "BOGOTA", "MEDELLIN", "CALI", "CARTAGENA"];
  const destinoInternacional = ["MADRID", "LONDRES", "NUEVA_YORK", "BUENOS_AIRES", "MIAMI"];

  const currentOrigen = "{{ vuelo.origen }}";
  const currentDestino = "{{ vuelo.destino }}";

  function cargarOpciones(tipo) {
    origenSelect.innerHTML = "";
    destinoSelect.innerHTML = "";

    let origenes = [];
    let destinos = [];

    if (tipo === "NACIONAL") {
      origenes = nacionales;
      destinos = nacionales;
    } else if (tipo === "INTERNACIONAL") {
      origenes = origenInternacional;
      destinos = destinoInternacional;
    }

    origenes.forEach(op => {
      const option = document.createElement("option");
      option.value = op;
      option.textContent = op;
      if (op === currentOrigen) option.selected = true;
      origenSelect.appendChild(option);
    });

    destinos.forEach(op => {
      const option = document.createElement("option");
      option.value = op;
      option.textContent = op;
      if (op === currentDestino) option.selected = true;
      destinoSelect.appendChild(option);
    });
  }

  tipoSelect.addEventListener("change", () => cargarOpciones(tipoSelect.value));
  cargarOpciones(tipoSelect.value); // inicializar al cargar
});

// === Calcular fecha y hora de llegada autom谩ticamente ===
document.addEventListener("DOMContentLoaded", () => {
  const origenSelect = document.getElementById("id_origen");
  const destinoSelect = document.getElementById("id_destino");
  const fechaSalidaInput = document.querySelector("[name='fecha_salida']");
  const horaSalidaInput = document.querySelector("[name='hora_salida']");
  const fechaLlegadaInput = document.querySelector("[name='fecha_llegada']");
  const horaLlegadaInput = document.querySelector("[name='hora_llegada']");

  // Duraciones estimadas de vuelos (horas)
  const duraciones = {
    "NACIONAL": 2,
    "INTERNACIONAL": 10,
  };

  function calcularLlegada() {
    const tipo = document.getElementById("id_tipo").value;
    const fechaSalida = fechaSalidaInput.value;
    const horaSalida = horaSalidaInput.value;

    if (!fechaSalida || !horaSalida) return;

    // Convertir a objeto Date
    const salida = new Date(`${fechaSalida}T${horaSalida}`);
    const duracionHoras = duraciones[tipo] || 2;
    const llegada = new Date(salida.getTime() + duracionHoras * 60 * 60 * 1000);

    // Actualizar campos
    const fechaISO = llegada.toISOString().split("T")[0];
    const horaISO = llegada.toTimeString().slice(0, 5);
    fechaLlegadaInput.value = fechaISO;
    horaLlegadaInput.value = horaISO;
  }

  origenSelect.addEventListener("change", calcularLlegada);
  destinoSelect.addEventListener("change", calcularLlegada);
  fechaSalidaInput.addEventListener("change", calcularLlegada);
  horaSalidaInput.addEventListener("change", calcularLlegada);
});
</script>
{% endblock %}
